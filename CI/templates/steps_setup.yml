steps:
- bash: |
    ###
    ###  Set MACHINE
    ###
    case ${{ parameters.machine }} in
        qemuarm64 )
            echo "##vso[task.setvariable variable=machine;]qemuarm64"
            ;;
        qemuarm )
            echo "##vso[task.setvariable variable=machine;]qemuarm"
            ;;
        qemuriscv64 )
            echo "##vso[task.setvariable variable=machine;]qemuriscv64"
            ;;
        qemuriscv32 )
            echo "##vso[task.setvariable variable=machine;]qemuriscv32"
            ;;
        *)
            echo "Unknown MACHINE requested"
            exit 1
            ;;
    esac

    echo "##vso[task.setvariable variable=DEPLOY_ARTIFACTS_DIR;]/mnt/deploydir/"
  displayName: 'Set global variables'

- bash: |
    git clone https://www.github.com/aehs29/azp-scripts/
    chmod +x azp-scripts/azp-helpers.sh
    source azp-scripts/azp-helpers.sh
    free_space_packages
    setup_yp_deps
    cleanup_leftover_deps
    setup_yp_deps
    create_local_dirs
  displayName: 'Setup container'

- bash: |
    source azp-scripts/azp-helpers.sh
    BRANCH=${{ parameters.build_branch }} clone_layers poky
  continueOnError: false
  displayName: 'Clone Repositories'

- bash: |
    source azp-scripts/azp-helpers.sh
    AZ_SAS="$(SAS_TOKEN)" RMWORK="0" localconf
    add_layers skeleton
  continueOnError: false
  displayName: 'Create bitbake configuration'
